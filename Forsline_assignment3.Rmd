---
title: "EDS 241 Assignment 2"
author: "Mia Forsline"
date: "2/20/2022"
output: 
  pdf_document:
    toc: false
    number_sections: yes
  html_document:
    theme: flatly
    code_folding: show
    toc: true
    toc_float: true
    number_sections: false 
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
---

# Set Up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE)

packages=c("cowplot",
           "datasets", 
           "dplyr",
           "estimatr",
           "here", 
           "ggplot2",
           "janitor",
           "stargazer", 
           "stringr",
           "tibble",
           "tidyverse",
           "tidyr", 
           "tinytex"
           )

for (i in packages) {
  if (require(i,character.only=TRUE)==FALSE) {
    install.packages(i,repos='http://cran.us.r-project.org')
  }
  else {
    require(i,character.only=TRUE)
  }
}

options(scipen=999) # not scientific notation
```

# Introduction

## Goal: to estimate the causal effect of maternal smoking during pregnancy on infant birth weight using the treatment ignorability assumptions

-   data come from the [Child & Family Data Archive's](https://www.childandfamilydataarchive.org/cfda/pages/cfda/index.html;jsessionid=0A67B5A8C563D765D595DD10EB38A777) [National Natality Detail Files](https://www.childandfamilydataarchive.org/cfda/cfda/series/36#:~:text=The%20public%2Duse%20Natality%20Detail,births%20occurring%20in%20each%20state.)
-   the data we will be using is a random sample of all births in Pennsylvania during 1989 - 1991
-   each observation is a mother-infant pair

## Variables

-   Outcome variable: `birthwgt` = birth weight of infant in grams

-   Treatment variable: `tobacco` = indicator for maternal smoking

-   Control variables:

    -   `mage` = mother's age
    -   `meduc` = mother's education
    -   `mblack` = 1 if the mother is Black
    -   `alcohol` = 1 if the mother consumed alcohol during pregnancy
    -   `first` = 1 if this is the mother's first child
    -   `diabete` = 1 if the mother is diabetic
    -   `anemia` = 1 if the mother is anemic

## Note

This homework is a simple examination of these data. More research would be needed to obtain a more definitive assessment of the causal effect of smoking on infant health outcomes. Further, for this homework, you can ignore the adjustments to the standard errors that are necessary to reflect the fact that the propensity score is estimated. Just use heteroskedasticity robust standard errors in R. If you are interested, you can read Imbens and Wooldridge (2009) and Imbens (2014) for discussions of various approaches and issues with standard error estimations in models based on the propensity score

```{r}
data <- read_csv(here("data", "SMOKING_EDS241.csv"))

data <- data %>% 
  mutate(mage = as.numeric(mage), 
         meduc = as.numeric(meduc), 
         mblack = as.factor(mblack), 
         alcohol = as.factor(alcohol), 
         first = as.factor(first), 
         diabete = as.factor(diabete), 
         anemia = as.factor(anemia)
         )
```

# (a) What is the unadjusted mean difference in birth weight of infants with smoking and nonsmoking mothers?

```{r}
data_smoke <- subset(data, tobacco == 1)
smoke_mean <- round(mean(data_smoke$birthwgt), digits = 2)

data_no_smoke <- subset(data, tobacco == 0)
no_smoke_mean <- round(mean(data_no_smoke$birthwgt), digits = 2)

diff <- no_smoke_mean - smoke_mean

#this could also be a linear regression 

#what would need to be true for this unadjusted mean difference to be the true ATE? We have treatment ignorability unconditional on X 
```

\noindent On average, smoking mothers give birth to babies that weight `r smoke_mean`g. On average, non-smoking mothers give birth to babies that weight `r no_smoke_mean`g. Thus, the unadjusted mean difference in infant birth weights between smoking and nonsmoking mothers is `r diff`g.

## (a) Under what hypothesis does this correspond to the average treatment effect of maternal smoking during pregnancy on infant birth weight? Provide some simple empirical evidence for or against this hypothesis.

```{r}
y1 <- round(mean(data_smoke$birthwgt), digits = 2)
y0 <- round(mean(data_no_smoke$birthwgt), digits = 2)

ate <- y1 - y0

#it is unrealistic that smoking status is randomly assigned 
#show that when we condition on different demographic variables, the difference between smokers and non-smokers is not equal 

#is D independent of Y(1) and Y(0)? 

#income ~ smoking status
#education ~ smoking status
#age ~ smoking status 

#we just want to show that smoking is not randomly assigned to mothers (as it would be in an ideal experiment)
#if we find differences in income between smoking vs non-smoking mothers, is that difference statistically significant? 

#if smoking was randomly assigned to mothers, then we would find no significant differences in income/education/age between smoking and non-smoking mothers 

#hypothesis/assumption: smoking status is independent of Y(1) and Y(0) - we'd need smoking status to be randomly assigned to mothers unconditionally 
```

\noindent The average treatment effect (ATE) is the expected value of $Y(1)$ - $Y(0)$ within the population of interest. Thus, we would hypothesize that for mothers giving birth in Pennsylvania during 1989 - 1991, smoking during pregnancy influences infant birth weight. Specifically, we hypothesize that smoking during pregnancy results in lower infant birth weight.

\noindent H~0~: Maternal smoking during pregnancy does not influence infant birth weight ($\mu$ = 0)

\noindent H~A~: Maternal smoking during pregnancy does influence infant birth weight ($\mu$ $\neq$ 0)

\noindent In this case, $Y(1)$ = `r y1` and $Y(0)$ = `r y0`, so the ATE = `r ate`.

# (b) Assume that maternal smoking is randomly assigned conditional on the observable covariates listed above. Estimate the effect of maternal smoking on birth weight using a linear regression. Report the estimated coefficient on tobacco and its standard error

```{r}
lm_robust(birthwgt ~ tobacco + mage + meduc + mblack + alcohol + first + diabete + anemia, data = data)
```


\noindent Table 1 shows the estimated coefficients and standard error of maternal smoking during pregnancy on infant birth weight (g). 

```{r , results = 'asis', echo = FALSE}
mdl <- lm(birthwgt ~ tobacco + mage + meduc + mblack + alcohol + first + diabete + anemia, data = data)

mdl_se <- starprep(mdl, 
                   stat = c("std.error"), 
                   se_type = "HC2", 
                   alpha = 0.05)

stargazer(mdl,  
          se = mdl_se, 
          type = "latex", 
          ci = FALSE, 
          no.space = TRUE, 
          header = FALSE, 
          omit = c("Constant", 
                   "mage",
                   "meduc", 
                   "mblack", 
                   "alcohol", 
                   "first",
                   "diabete",
                   "anemia"),  
          omit.stat = c("adj.rsq","ser", "f"),
          covariate.labels = c("Maternal Smoking"),
          dep.var.labels = c("Infant Birth Weight (g)"),
          title = "Maternal Smoking During Pregnancy Decreases Infant Birth Weights", 
          table.placement = "H"
          )
```


# (c) Use the exact matching estimator to estimate the effect of maternal smoking on birth weight. 

For simplicity, consider the following covariates in your matching estimator: 
- create a 0-1 indicator for mother's age (=1 if mage\>=34)
- and a 0-1 indicator for mother's education (1 if meduc\>=16) 
- mother's race (mblack)
- and alcohol consumption indicator (alcohol). 

These 4 covariates will create 2x2x2x2 = 16 cells. 

Report the estimated average treatment effect of smoking on birthweight using the exact matching estimator and its linear regression analogue (Lecture 6, slides 12-14).

```{r}
data_matching <- data %>% 
  mutate(mage_ind = case_when(
    mage >= 34 ~ 1,
    mage < 34 ~ 0),
    meduc_inc = case_when(
      meduc >= 16 ~ 1,
      meduc < 16 ~ 0)
    )

#exact matching estimator 


#linear regression analogue 
mdl3 <- lm_robust(birthwgt ~ tobacco + 
                   mage + meduc + mblack + alcohol + 
                   mage:meduc + 
                   mage:mblack + 
                   mage:alcohol + 
                   meduc:mblack + 
                   meduc:alcohol + 
                   mblack:alcohol + 
                   mage:meduc:mblack +
                   mage:meduc:alcohol + 
                   meduc:mblack:alcohol + 
                   tobacco:mage:meduc:mblack:alcohol, data = data)
mdl3

#interactions for mage, meduc, mblack, alcohol 
#google fully saturated model 


lm_robust(birthwgt ~ tobacco) 
```


# (d) Estimate the propensity score for maternal smoking using a logit estimator and based on the following specification: mother's age, mother's age squared, mother's education, and indicators for mother's race, and alcohol consumption.

```{r}
# BASIC PROPENSITY SCORE --- THIS IS A TOY MODEL
# ESTIMATE PROPENSITY SCORE MODEL AND PREDICT (EPS)

#what is the probability that D = 1 ? 

ps_model <- glm(DAPever ~ LME + genus, family = binomial(), data = CGL)
summary(ps_model)

EPS <- predict(ps_model, type = "response") #use estimated logistic equation to create EPS (estimated propensity score)

PS_WGT <- (CGL$DAPever/EPS) + ((1-CGL$DAPever)/(1-EPS)) #PS_WGT = p-score weight
```


# (e) Use the propensity score weighted regression (WLS) to estimate the effect of maternal smoking on birth weight (Lecture 7, slide 12).

```{r}
# COLLECT ALL RELEVANT VARIABLES IN DATAFRAME
DF <- data.frame(years = CGL$years, collapse = CGL$collapse, DAPever = CGL$DAPever, 
                 LME = CGL$LME, genus = CGL$genus, species = CGL$species, EPS, PS_WGT)


# BOXPLOTS TO EXAMINE OVERLAP IN P-SCORE DISTRIBUTIONS

#not perfectly aligned, but reasonably aligned, especially around the median 

ggplot(DF, aes(x=as.factor(DAPever), y=EPS)) + 
  geom_boxplot(fill="cyan") + xlab("ITQ Yes or No")


# WLS USING EPS WEIGHTS
wls1 <- lm(formula = collapse ~ DAPever, data=DF, weights=PS_WGT)
wls2 <- lm(formula = collapse ~ DAPever + LME + genus, data=DF, weights=PS_WGT) #adding linear controls doesn't change the coefficients much 
se_models = starprep(wls1, wls2, stat = c("std.error"), se_type = "HC2", alpha = 0.05)
stargazer(wls1, wls2, se = se_models, type="text", omit = "(LME)|(genus)|(species)")

# if you don't adjust (-14.2%)
# if you do adjust, we get a very similar -14.8%, so either there was no bias or the controls removed very little bias 
```

