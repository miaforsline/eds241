---
title: "EDS 241: Assignment 1"
author: "Mia Forsline"
date: "1/21/2022"
output: 
  pdf_document:
    toc: false
    number_sections: yes
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, 
                      echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE)

packages=c("stargazer", 
           "here", 
           "tidyr", 
           "dplyr",
           "stringr", 
           "janitor", 
           "cowplot", 
           "ggplot2", 
           "tinytex", 
           "datasets", 
           "tibble")

for (i in packages) {
  if (require(i,character.only=TRUE)==FALSE) {
    install.packages(i,repos='http://cran.us.r-project.org')
  }
  else {
    require(i,character.only=TRUE)
  }
}

options(scipen=999) # not scientific notation

library(tidyverse)
library(here)
library(patchwork)
library(estimatr)
library(car)
```

# Introduction

This assignment uses data from [CalEnviroScreen 4.0](https://oehha.ca.gov/calenviroscreen/report/calenviroscreen-40), a mapping and data tool produced by the California Office of Environmental Health Hazards Assessment (OEHHA). The data are compiled and constructed from a variety of sources and cover all 8,035 census tracts in California.

Specifically, I used the following variables:

-   census tract ID,

-   total population,

-   California county name (the county where the census tract is located),

-   Low Birth Weight (% of census tract births with weight \< 2500g),

-   PM25 (ambient concentrations of PM2.5 in the census tract, in µg/m^3^),

-   and Poverty (% of population in the census tract living below twice the federal poverty line).

## Read in and clean data

Select variables of interest

```{r}
    data <- read_csv(here("data", "CES4.csv"))

    data_clean <- data %>% 
      clean_names()


    data_clean <- data_clean %>% 
      select(census_tract,
             california_county,
             total_population,
             low_birth_weight,
             pm2_5,
             poverty)
```

# (a) What is the average concentration of PM2.5 across all census tracts in California?

```{r}
mean_pm2.5 <- mean(data_clean$pm2_5) %>% 
  round(digits = 2)
mean_pm2.5
```

The mean concentration of PM2.5 across all census tracts in California is `r mean_pm2.5` µg/m^3^.

# (b) What county has the highest level of poverty in California?

Drop counties with NA values for poverty

```{r}
data_pov <- data_clean %>% 
  drop_na(poverty)

max_pov_county <- subset(data_pov, poverty == max(data_pov$poverty))
max_pov_county <- max_pov_county$california_county
max_pov_county

```

`r max_pov_county` is the county with the highest level of poverty in California.

# (c) Make a histogram depicting the distribution of percent low birth weight and PM2.5

```{r}

pm_lab <- expression(paste("PM2.5 (µg/m"^"3",")")) 

p1 <- ggplot(data = data_clean) + 
  geom_histogram(aes(x = low_birth_weight),
                 binwidth = 0.25) + 
  theme_classic() + 
  labs(y = "Frequency", 
       x = "% of Low Birth Weights")

p2 <- ggplot(data = data_clean) + 
  geom_histogram(aes(x = pm2_5),
                 binwidth = 0.5) + 
  theme_classic() + 
  labs(y = "Frequency", 
       x = pm_lab)
```

\newpage

<center>

**Figure 1: Distributions of low birth weights and PM2.5 in California census tracts**

</center>

```{r , fig.width = 4, fig.height = 3, eval=TRUE, echo=FALSE}
p1 / p2
```

\noindent Figure 1 shows the distributions of % birth weights \< 2500g and ambient concentrations of PM2.5 (µg/m^3^) per census tract. Data is sourced from CalEnviroScreen 4.0.

# (d) Estimate a OLS regression of LowBirthWeight on PM25. Report the estimated slope coefficient and its heteroskedasticity-robust standard error. Interpret the estimated slope coefficient. Is the effect of PM25 on LowBirthWeight statistically significant at the 5%?

```{r}
mdl <- lm(low_birth_weight ~ pm2_5, data=data_clean)
summary(mdl)
```

The estimated slope coefficient for PM2.5 ($\beta_1$) = `r mdl$coefficients[2]`, meaning that a 1 µg/^3^ change in PM2.5 on average associates with a `r mdl$coefficients[2]` increase in Low Birth Rate. At the 5% significance level, the effect of PM2.5 on Low Birth Weight is statistically significant.

# (e) Suppose a new air quality policy is expected to reduce PM2.5 concentration by 2 micrograms per cubic meters. Predict the new average value of LowBirthWeight and derive its 95% confidence interval. Interpret the 95% confidence interval.

```{r}
#PM2.5 = 9.13552 + 0.21198 * LBW
x = -2
int = mdl$coefficients[1]
b1 = mdl$coefficients[2]
y = mdl$coefficients[1] + mdl$coefficients[2] * x

ci <- confint(object = mdl, parm = "pm2_5", level = 0.95)
ci

```

Given the equation: PM2.5 = `mdl$coefficients[1]` + `mdl$coefficients[2]` \* LowBirthWeight, if PM2.5 is reduced by 2, then we predict the Low Birth Rate to be `r y`%. The 95% confidence interval is bounded by `r ci[1]` and `r ci[2]`, meaning we are 95% confident that the true parameter $\beta_1$ lies within this interval.

# (f) Add the variable Poverty as an explanatory variable to the regression in (d). Interpret the estimated coefficient on Poverty. What happens to the estimated coefficient on PM25, compared to the regression in (d). Explain.

```{r}
mdl <- lm(low_birth_weight ~ pm2_5 + poverty, data=data_clean)
summary(mdl)
```

The estimated slope coefficient for Poverty ($\beta_2$) = `r mdl$coefficients[3]`, meaning that a 1 µg/^3^ change in PM2.5 on average associates with a `r mdl$coefficients[3]` increase in Low Birth Rate. Compared to the prior model, the slope coefficient of PM2.5 ($\beta_1$) has decreased to `r mdl$coefficients[2]` because Poverty helps explain some of the change in Low Birth Weight. In other words, the prior model suffered from omitted variables bias and caused us to overestimate the impact of PM2.5 alone on Low Birth Weight.

# (g) From the regression in (f), test the null hypothesis that the effect of PM2.5 is equal to the effect of Poverty

H0: PM2.5 = Poverty

HA: PM2.5 != Poverty

```{r}
linearHypothesis(model = mdl, hypothesis.matrix = c("pm2_5 = poverty"), white.adjust = "hc2")
```
